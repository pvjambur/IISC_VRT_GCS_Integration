<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Data Verification</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #560bad;
            --background-color: var(--light);
            --text-color: var(--dark);
            --card-background: white;
            --border-color: #eee;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #121212;
                --text-color: #e0e0e0;
                --card-background: #1e1e1e;
                --border-color: #333;
                --primary: #4e70e0;
                --secondary: #3f51b5;
                --danger: #ff6090;
                --success: #00bcd4;
                --warning: #fbc02d;
            }
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { display: flex; min-height: 100vh; background-color: var(--background-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .sidebar { width: 250px; background: var(--card-background); box-shadow: 2px 0 10px rgba(0,0,0,0.1); padding: 20px 0; transition: background 0.3s; }
        .sidebar-header { padding: 0 20px 20px; border-bottom: 1px solid var(--border-color); }
        .sidebar-header h2 { color: var(--primary); }
        .sidebar-menu { list-style: none; margin-top: 20px; }
        .sidebar-menu li { margin-bottom: 5px; }
        .sidebar-menu a { display: block; padding: 12px 20px; color: var(--text-color); text-decoration: none; transition: all 0.3s; border-left: 3px solid transparent; }
        .sidebar-menu a:hover, .sidebar-menu a.active { background: rgba(67, 97, 238, 0.1); border-left: 3px solid var(--primary); color: var(--primary); }
        .sidebar-menu i { margin-right: 10px; }
        .main-content { flex: 1; padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: var(--text-color); }
        .drive-space { background: var(--card-background); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; transition: background 0.3s; }
        .space-meter { width: 150px; height: 10px; background: var(--border-color); border-radius: 5px; margin: 0 10px; overflow: hidden; }
        .space-used { height: 100%; background: var(--primary); border-radius: 5px; }
        .data-table { background: var(--card-background); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; transition: background 0.3s; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--light); font-weight: 600; color: var(--dark); }
        tr:hover { background: rgba(67, 97, 238, 0.05); }
        .video-link { color: var(--primary); text-decoration: none; font-weight: 500; cursor: pointer; }
        .video-link:hover { text-decoration: underline; }
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 5px; font-weight: bold; color: white; }
        .status-pending { background-color: var(--warning); }
        .status-approved { background-color: var(--success); }
        .status-rejected { background-color: var(--danger); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); padding-top: 60px; justify-content: center; align-items: center; }
        .modal-content { margin: auto; display: block; width: 90%; max-width: 1000px; position: relative; }
        .modal-content img { width: 100%; height: auto; display: block; }
        .modal-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
        .modal-details { color: white; padding: 20px 0; text-align: center; }
        .verification-form { background: var(--card-background); padding: 20px; border-radius: 8px; margin-top: 20px; color: var(--text-color); transition: background 0.3s; }
        .form-group { margin-bottom: 15px; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        .btn.reject { background: var(--danger); }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Patient Data</h2>
        </div>
        <ul class="sidebar-menu">
            <li><a href="/"><i class="fas fa-chart-line">ðŸ“Š</i> Viewer Dashboard</a></li>
            <li><a href="/verifier" class="active"><i class="fas fa-clipboard-check">ðŸ“‹</i> Verifier Dashboard</a></li>
            <li><a href="/upload"><i class="fas fa-cloud-upload-alt">ðŸ“¤</i> Upload Data</a></li>
        </ul>
    </div>
    
    <div class="main-content">
        <div class="header">
            <h1>Verifier Records</h1>
            <div class="drive-space">
                <span>Drive: <span id="space-used">{{ drive_space.used }}</span>GB / <span id="space-total">{{ drive_space.total }}</span>GB</span>
                <div class="space-meter">
                    <div class="space-used" style="width: {{ drive_space.percentage | default(0) }}%"></div>
                </div>
                <span id="space-percentage">{{ drive_space.percentage }}%</span>
            </div>
        </div>
        
        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th>Folder</th>
                        <th>Name</th>
                        <th>Age</th>
                        <th>Gender</th>
                        <th>Condition</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data %}
                    <tr>
                        <td>{{ item.folder }}</td>
                        <td>{{ item.info.content.Name }}</td>
                        <td>{{ item.info.content.Age }}</td>
                        <td>{{ item.info.content.Gender }}</td>
                        <td>{{ item.info.content.Condition }}</td>
                        <td>
                            <span class="status-badge status-{{ item.status.lower() }}">{{ item.status }}</span>
                        </td>
                        <td>
                            {% if item.status == 'Pending' %}
                            <a class="video-link" href="#" onclick="openVerificationModal('{{ item.folder }}');">Verify Video</a>
                            {% else %}
                            <span style="color: grey;">Verification Complete</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div id="verification-modal" class="modal">
        <span class="modal-close" onclick="closeVerificationModal()">&times;</span>
        <div class="modal-content">
            <h2 id="modal-patient-name" style="color:white; text-align:center;"></h2>
            <img id="video-stream" style="width:100%;">
            <div class="modal-details">
                <p><strong>Age:</strong> <span id="modal-patient-age"></span></p>
                <p><strong>Gender:</strong> <span id="modal-patient-gender"></span></p>
                <p><strong>Condition:</strong> <span id="modal-patient-condition"></span></p>
            </div>
            <div class="verification-form">
                <form id="verification-form">
                    <input type="hidden" id="folder-name-input" name="folder_name">
                    <div class="form-group">
                        <label for="reason">Rejection Reason (if applicable)</label>
                        <textarea id="reason" name="reason" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn" onclick="submitVerification('Approved')">Approve</button>
                        <button type="button" class="btn reject" onclick="submitVerification('Rejected')">Reject</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        const verificationModal = document.getElementById('verification-modal');
        const videoStream = document.getElementById('video-stream');
        const folderNameInput = document.getElementById('folder-name-input');
        const reasonInput = document.getElementById('reason');

        async function openVerificationModal(folderName) {
            try {
                const detailsResponse = await fetch(`/api/videos/${folderName}/details`);
                if (!detailsResponse.ok) {
                    throw new Error('Details not found.');
                }
                const details = await detailsResponse.json();
                
                document.getElementById('modal-patient-name').textContent = details.info.Name;
                document.getElementById('modal-patient-age').textContent = details.info.Age;
                document.getElementById('modal-patient-gender').textContent = details.info.Gender;
                document.getElementById('modal-patient-condition').textContent = details.info.Condition;
                
                folderNameInput.value = folderName;
                reasonInput.value = details.info.Reason || '';
                
                videoStream.src = `/api/videos/${folderName}/play?apply_opencv=true`;
                
                verificationModal.style.display = 'flex';
            } catch (error) {
                console.error("Error opening modal:", error);
                alert("Could not load video for verification. Error: " + error.message);
            }
        }

        function closeVerificationModal() {
            videoStream.src = ''; 
            verificationModal.style.display = 'none';
        }

        async function submitVerification(status) {
            const formData = new FormData();
            formData.append('folder_name', folderNameInput.value);
            formData.append('status', status);
            formData.append('reason', reasonInput.value);
            
            try {
                const response = await fetch('/api/verification', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Verification submitted successfully!');
                    closeVerificationModal();
                    window.location.reload();
                } else {
                    throw new Error(result.detail || 'Submission failed');
                }
            } catch (error) {
                console.error('Verification error:', error);
                alert(`Error: ${error.message}`);
            }
        }

        async function updateDriveSpace() {
            const response = await fetch('/api/drive_space');
            const data = await response.json();
            
            document.getElementById('space-used').textContent = data.used;
            document.getElementById('space-total').textContent = data.total;
            document.getElementById('space-percentage').textContent = `${data.percentage}%`;
            document.querySelector('.space-used').style.width = `${data.percentage}%`;
        }
        
        setInterval(updateDriveSpace, 30000);
    </script>
</body>
</html>